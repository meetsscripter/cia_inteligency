<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Relatório de Inteligência</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      padding: 40px;
      background-color: #0d1117;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #c9d1d9;
    }

    h1 {
      text-align: center;
      font-size: 36px;
      margin-bottom: 40px;
      color: #58a6ff;
    }

    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 50px;
    }

    .card {
      background-color: #161b22;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 0 12px rgba(88,166,255,0.2);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: 0.3s ease;
    }

    .card:hover {
      box-shadow: 0 0 18px rgba(88,166,255,0.4);
    }

    .card h2 {
      font-size: 20px;
      color: #58a6ff;
      margin-bottom: 10px;
    }

    .card p {
      margin: 4px 0;
      font-size: 16px;
    }

    .charts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 30px;
      margin-top: 50px;
    }

    .chart-container {
      background-color: #161b22;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 0 12px rgba(88,166,255,0.2);
      height: auto;
    }

    canvas {
      max-width: 100%;
      max-height: 300px;
    }

    .ranking {
      margin-top: 40px;
      background-color: #161b22;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 12px rgba(88,166,255,0.2);
    }

    .ranking h2 {
      color: #58a6ff;
      margin-bottom: 10px;
    }

    .ranking ol {
      padding-left: 20px;
    }

    .ranking li {
      margin: 8px 0;
    }
  </style>
</head>
<body>
  <div class="container" id="formContainer">
    <p id="ipCensurado">IP: <span id="ipTexto"></span> <span id="mostrarIP">(Mostrar)</span></p>
    <h1>Relatório de Inteligência</h1>

    <div id="lista" class="dashboard"></div>

    <div class="charts">
      <div class="chart-container"><canvas id="bonusChart"></canvas></div>
      <div class="chart-container"><canvas id="horasChart"></canvas></div>
      <div class="chart-container"><canvas id="registrosChart"></canvas></div>
    </div>

    <div class="ranking">
      <h2>Ranking de Bonificação</h2>
      <ol id="rankingLista"></ol>
    </div>
  </div>

  <div id="acessoNegado" style="display:none;">
    <div class="container">
        <h1>Acesso Negado</h1>
        <p>Seu IP não está na lista de IPs permitidos.</p>
        <p id="ipCensuradoNegado">IP: <span id="ipTextoNegado"></span> <span id="mostrarIPNegado">(Mostrar)</span></p>
    </div>
</div>


  <script>

        // Impede o clique direito
        document.addEventListener("contextmenu", function(event) {
            event.preventDefault();
        });

        // Bloqueia atalhos de desenvolvedor
        document.addEventListener("keydown", function(event) {
            if (event.ctrlKey && (event.key === "u" || event.key === "s" || event.key === "i" || event.key === "j")) {
                event.preventDefault();
            }
            if (event.keyCode === 123) { // Bloqueia tecla F12
                event.preventDefault();
            }
        });

        // Detecta a abertura do DevTools e força um redirecionamento
        setInterval(function() {
            let before = new Date().getTime();
            debugger; // Caso o DevTools seja aberto, o tempo de execução muda
            let after = new Date().getTime();
            if (after - before > 100) {
                window.location.href = "about:blank"; // Fecha o site
            }
        }, 500);

        // Impede a seleção de texto, mas permite interações com campos de texto
        document.addEventListener("mousedown", function(event) {
            if (event.target.tagName !== "INPUT" && event.target.tagName !== "TEXTAREA") {
                event.preventDefault();
            }
        });

        // Função para obter o IP do cliente
        async function getClientIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.error('Erro ao obter o IP:', error);
                return null;
            }
        }

        // Função para verificar o IP do cliente
        async function verificarAcesso() {
    const clientIP = await getClientIP();
    console.log('IP do cliente:', clientIP);

    if (!clientIP) {
        return;
    }

    try {
        const response = await fetch('ips.json');
        const ipsPermitidos = await response.json();
        console.log('Conteúdo de ips.json:', ipsPermitidos);
        console.log('Pagina atual:', window.location.pathname.split('/').pop());

        if (ipsPermitidos[clientIP] && ipsPermitidos[clientIP].pages.includes(window.location.pathname.split('/').pop())) {
            // IP permitido
            document.getElementById('formContainer').style.display = 'block';
            exibirIP(clientIP, 'ipTexto', 'mostrarIP');
            userName = ipsPermitidos[clientIP].discord;
            nomeCompleto = ipsPermitidos[clientIP].nomeCompleto;
        } else {
            // IP não permitido
            document.getElementById('acessoNegado').style.display = 'block';
            document.getElementById('formContainer').style.display = 'none';
            exibirIP(clientIP, 'ipTextoNegado', 'mostrarIPNegado');
        }
    } catch (error) {
                console.error('Erro ao carregar a lista de IPs:', error);
                document.getElementById('acessoNegado').style.display = 'block';
                document.getElementById('formContainer').style.display = 'none';
            }
}

        // Função para exibir o IP e configurar a alternância
        function exibirIP(clientIP, ipTextoId, mostrarIPId) {
            let ipCensurado = clientIP.replace(/\d/g, '*');
            document.getElementById(ipTextoId).textContent = ipCensurado;

            document.getElementById(mostrarIPId).onclick = function() {
                if (document.getElementById(ipTextoId).textContent === ipCensurado) {
                    document.getElementById(ipTextoId).textContent = clientIP;
                    document.getElementById(mostrarIPId).textContent = '(Ocultar)';
                } else {
                    document.getElementById(ipTextoId).textContent = ipCensurado;
                    document.getElementById(mostrarIPId).textContent = '(Mostrar)';
                }
            };
        }

        // Verifica o acesso ao carregar a página
        verificarAcesso();
        let userName = ''; // Variável para armazenar o nome do usuário
        let nomeCompleto = ''; // Variável para armazenar o nome completo

    const API_URL = "https://script.google.com/macros/s/AKfycbyEGgkE55FQpA1teX4LF95f0nddkOWbHHfW1rNPuduq2OYOn4pe29FgMo57SATepEfS/exec";

    function somarHoras(horas) {
      let totalSegundos = 0;

      horas.forEach(horaStr => {
        const [h, m, s] = horaStr.split(":").map(Number);
        totalSegundos += h * 3600 + m * 60 + s;
      });

      const h = Math.floor(totalSegundos / 3600);
      const m = Math.floor((totalSegundos % 3600) / 60);
      const s = totalSegundos % 60;

      return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    }

    fetch(API_URL)
      .then(res => res.json())
      .then(dados => {
        const lista = document.getElementById("lista");
        const rankingLista = document.getElementById("rankingLista");
        const totais = {};

        dados.forEach(item => {
          const nome = item["RESPONSÁVEL"]?.trim() || "Desconhecido";
          const bonus = parseFloat(item["BÔNUS"]) || 0;
          const horasStr = item["HORAS"]?.trim() || "00:00:00";

          if (!totais[nome]) {
            totais[nome] = { bonusTotal: 0, horas: [], quantidade: 0 };
          }

          totais[nome].bonusTotal += bonus;
          totais[nome].horas.push(horasStr);
          totais[nome].quantidade += 1;
        });

        const nomes = [], bonusValores = [], horasSomas = [], registrosValores = [];
        const ranking = Object.entries(totais).sort((a, b) => b[1].bonusTotal - a[1].bonusTotal);

        ranking.forEach(([nome, info]) => {
          const somaHoras = somarHoras(info.horas);

          const div = document.createElement("div");
          div.className = "card";

          div.innerHTML = `
            <h2>${nome}</h2>
            <p><strong>Bônus Total:</strong> ${info.bonusTotal}</p>
            <p><strong>Horas Totais:</strong> ${somaHoras}</p>
            <p><strong>Registros:</strong> ${info.quantidade}</p>
          `;

          lista.appendChild(div);
          nomes.push(nome);
          bonusValores.push(info.bonusTotal);
          horasSomas.push(info.horas.length);
          registrosValores.push(info.quantidade);

          const li = document.createElement("li");
          li.textContent = `${nome} — ${info.bonusTotal}$`;
          rankingLista.appendChild(li);
        });

        const chartOptions = {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, ticks: { color: '#c9d1d9' } },
            x: { ticks: { color: '#c9d1d9' } }
          }
        };

        new Chart(document.getElementById('bonusChart'), {
          type: 'bar',
          data: {
            labels: nomes,
            datasets: [{ label: 'Bônus por Responsável', data: bonusValores, backgroundColor: '#58a6ff' }]
          },
          options: chartOptions
        });

        new Chart(document.getElementById('horasChart'), {
          type: 'pie',
          data: {
            labels: nomes,
            datasets: [{
              label: 'Entradas de Horas por Responsável',
              data: horasSomas,
              backgroundColor: nomes.map((_, i) => `hsl(${i * 40}, 70%, 60%)`)
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { labels: { color: '#c9d1d9' } }
            }
          }
        });

        new Chart(document.getElementById('registrosChart'), {
          type: 'bar',
          data: {
            labels: nomes,
            datasets: [{ label: 'Número de Registros', data: registrosValores, backgroundColor: '#34d058' }]
          },
          options: chartOptions
        });
      })
      .catch(error => {
        console.error("Erro ao carregar dados:", error);
      });
  </script>
</body>
</html>
